function unserialize(p){for(var s,ret={},seg=p.replace(/^\?/,"").split("&"),len=seg.length,i=0;len>i;i++)seg[i]&&(s=seg[i].split("="),ret[s[0]]=s[1]);return ret}var Page=klass(function(worker){this.worker=worker});Page.statics({WEB_APP:"WebApp"}),Page.methods({init:function(){if(document.getElementsByTagName("iframe").length){this.frame=document.getElementsByTagName("iframe")[0].contentWindow,this.frameDoc=this.frame.document,$.cookie.raw=!0,this.authToken=$.cookie("siteAuthToken");var urlParams=unserialize($("#PPLink",$(this.frameDoc)).attr("href"));urlParams.hasOwnProperty("ASID")&&(this.siteID=urlParams.ASID);var script=document.createElement("script");script.textContent="if(authData && authData.hasOwnProperty('apiUrl')){ var input= document.createElement('input'); input.id='__siteApiBaseUrl'; input.type='text'; input.value = authData.apiUrl; document.body.appendChild(input);}",document.body.appendChild(script),this.apiUrl=$("#__siteApiBaseUrl").val()?"https://"+$("#__siteApiBaseUrl").val():null,$("#__siteApiBaseUrl").remove(),console.log(this.apiUrl,this.siteID)}},getContentType:function(){this.init(),this.frame&&this.frame.location.pathname.indexOf("/Admin/CustomContentType.aspx")>-1&&this.worker.postMessage({event:"Page:getContentType",data:Page.WEB_APP})},extractInputs:function(from){var result={},inputs=$("input:visible, textarea:visible, select:visible",from).filter(":enabled");if(0!=inputs.length)return inputs.each(function(){($(this).is("input[type=text]")||$(this).is("textarea")||$(this).is("select"))&&(result[$(this).attr("id")]=$(this).val()),($(this).is("input[type=checkbox]")||$(this).is("input[type=radio]"))&&(result[$(this).attr("id")]="checked"==$(this).attr("checked")?!0:!1)}),result},setInputs:function(data,context){$.each(data,function(k,val){var id="#"+k;($(id,context).is("input[type=text]")||$(id,context).is("textarea")||$(id,context).is("select"))&&$(id,context).val(val),($(id,context).is("input[type=checkbox]")||$(id,context).is("input[type=radio]"))&&$(id,context).attr("checked",val)})}});var SecureZone=Page.extend(function(){}),WebApp=Page.extend(function(){});WebApp.methods({getInfo:function(){this.init();var locationParams=unserialize(this.frame.location.search),response={name:$("#main h1 span").text()||"",id:locationParams.CustomContentID||-1};this.worker.postMessage({event:"WebApp:getInfo",data:response})},navigate:function(tabIndex){var tabs=$("#hybridSubmenu a",$(this.frameDoc));void 0!=tabs[tabIndex]&&tabs[tabIndex].click()},exportSettings:function(){this.init(),this.worker.postMessage({event:"Page:status",data:{text:"Exporting web app "+$("#main h1 span").text()}}),0==$("#hybridSubmenu li",$(this.frameDoc)).index($("#hybridSubmenu li.active",$(this.frameDoc)))?this.exportDetailsTab():($("iframe:first").bind("load",$.proxy(this.exportDetailsTab,this)),this.navigate(0))},exportDetailsTab:function(){this.init(),$("iframe:first").unbind("load");var data={details:this.extractInputs($(".hybridForm",$(this.frameDoc))),fields:{},layout:{},autoresponder:{}};this.worker.postMessage({event:"Page:status",data:{text:"Exporting web app "+$("#main h1 span").text()+" details tab"}}),$("iframe:first").bind("load",data,$.proxy(this.exportFieldsTab,this)),this.navigate(1)},exportFieldsTab:function(e){this.init(),$("iframe:first").unbind("load"),this.worker.postMessage({event:"Page:status",data:{text:"Exporting web app "+$("#main h1 span").text()+" fields tab"}});var self=this,data=e.data,context=$(this.frameDoc),fields=[],i=0,selectNextField=function(){$("#ctl00_cp_uc_listFormItems option:selected",context).is($("#ctl00_cp_uc_listFormItems option:last",context))&&(data.fields=fields,$("iframe:first").bind("load",data,$.proxy(self.exportLayoutTab,self)),self.navigate(2));var inputs=self.extractInputs($("#ctl00_cp_uc_panelFieldDetails",context));inputs&&fields.push(inputs),$("#ctl00_cp_uc_listFormItems",context).attr("onchange","javascript:setTimeout(function(){__doPostBack('ctl00$cp$uc$listFormItems','');}, 0)"),$("#ctl00_cp_uc_listFormItems option:selected",context).length?$("#ctl00_cp_uc_listFormItems",context).val($("#ctl00_cp_uc_listFormItems option:selected",context).next().attr("value")).trigger("change"):$("#ctl00_cp_uc_listFormItems",context).val($("#ctl00_cp_uc_listFormItems option:first",context).attr("value")).trigger("change")};context.on("DOMSubtreeModified","#ctl00_cp_uc_panelFieldDetails",function(){i++,2==i&&(i=0,selectNextField())}),selectNextField()},exportLayoutTab:function(e){this.init(),$("iframe:first").unbind("load"),this.worker.postMessage({event:"Page:status",data:{text:"Exporting web app "+$("#main h1 span").text()+" layout tab"}});var getTemplate,data=e.data,self=this,baseURL=self.apiUrl+"/api/v2/admin/sites/"+self.siteID+"/storage/Layouts/WebApps/"+encodeURIComponent($("#main h1 span").text());$("iframe:first").bind("load",data,$.proxy(this.exportAutoresponderTab,this)),(void 0==self.apiUrl||""==self.apiUrl)&&self.navigate(3),getTemplate=function(tpl,cb){$.ajax({url:baseURL+"/"+tpl+".html",headers:{Authorization:self.authToken},success:function(response){data.layout[tpl]=response,cb()},error:function(){self.worker.postMessage({event:"Page:status",data:{text:"Exporting "+tpl+" layout failed!.",css:"alert-error"}}),cb()}})},self.worker.postMessage({event:"Page:status",data:{text:"Exporting list layout"}}),getTemplate("list",function(){self.worker.postMessage({event:"Page:status",data:{text:"Exporting detail layout"}}),getTemplate("detail",function(){self.worker.postMessage({event:"Page:status",data:{text:"Exporting edit layout"}}),getTemplate("edit",function(){self.navigate(3)})})})},exportAutoresponderTab:function(e){this.init(),$("iframe:first").unbind("load");var data=e.data;data.autoresponder=this.extractInputs($(".main",$(this.frameDoc))),data.autoresponder.ctl00_cp_uc_reContentHiddenTextarea=$("#ctl00_cp_uc_reContentHiddenTextarea",$(this.frameDoc)).val(),this.worker.postMessage({event:"Page:status",data:{text:$("#main h1 span").text()+" exported successfully! Copy the export data and import it into a new website.",css:"alert-success"}}),this.worker.postMessage({event:"WebApp:exportSettings",data:data})},importSettings:function(data){this.init(),this.worker.postMessage({event:"Page:status",data:{text:"Importing web app settings started."}}),$("iframe:first").unbind("load"),0==$("#hybridSubmenu li",$(this.frameDoc)).index($("#hybridSubmenu li.active",$(this.frameDoc)))?this.importDetailsTab(null,data):($("iframe:first").bind("load",data,$.proxy(this.importDetailsTab,this)),this.navigate(0))},importDetailsTab:function(e,data){this.init(),this.worker.postMessage({event:"Page:status",data:{text:"Importing web app details."}}),$("iframe:first").unbind("load");try{var settings={},context=$(".hybridForm",$(this.frameDoc)),self=this;e&&e.data&&(settings=JSON.parse(e.data)),data&&(settings=JSON.parse(data)),this.setInputs(settings.details,context),$("iframe:first").bind("load",settings,$.proxy(this.importFieldsTab,this)),$(this.frameDoc).on("DOMSubtreeModified",".footerbuttons",function(){self.navigate(1)}),$("#ctl00_cp_btnSubmit",$(this.frameDoc)).trigger("click")}catch(e){this.worker.postMessage({event:"Page:status",data:{text:"Importing web app details failed!",css:"alert-error"}})}},addField:function(e){if(this.init(),$("iframe:first").unbind("load"),!$(e.target).is("#systemNotificationQueue")||""==$("#systemNotificationQueue").text()){var data=e.data,self=this,context=$(this.frameDoc);if(unserialize(this.frame.location.search),0==data.fields.length)return $("iframe:first").bind("load",data,$.proxy(this.importLayoutTab,this)),setTimeout($.proxy(this.navigate,this),1e3,2),void 0;fieldData=data.fields.shift(),this.setInputs(fieldData,context),$("#ctl00_cp_uc_btnAdd",$(self.frameDoc)).trigger("click")}},importFieldsTab:function(e){this.init(),this.worker.postMessage({event:"Page:status",data:{text:"Importing web app fields."}}),$("iframe:first").unbind("load");var data=e.data;return $(this.frameDoc),data.fields&&0!=data.fields.length?($("iframe:first").bind("load",data,$.proxy(this.addField,this)),$("#systemNotificationQueue").bind("DOMSubtreeModified",data,$.proxy(this.addField,this)),$("#ctl00_cp_uc_btnNew",$(this.frameDoc)).trigger("click"),void 0):($("iframe:first").bind("load",data,$.proxy(this.importLayoutTab,this)),this.navigate(2),void 0)},importLayoutTab:function(e){this.init(),this.worker.postMessage({event:"Page:status",data:{text:"Importing web app layouts."}}),$("iframe:first").unbind("load"),$("#systemNotificationQueue").unbind("DOMSubtreeModified");var saveTemplate,data=e.data,self=this,baseURL=($(this.frameDoc),self.apiUrl+"/api/v2/admin/sites/"+self.siteID+"/storage/Layouts/WebApps/"+encodeURIComponent($("#main h1 span").text()));$("iframe:first").bind("load",data,$.proxy(this.importAutoresponderTab,this)),(void 0==self.apiUrl||""==self.apiUrl)&&self.navigate(3),saveTemplate=function(tpl,cb){$.ajax({url:baseURL+"/"+tpl+".html",headers:{Authorization:self.authToken},method:"PUT",processData:!1,contentType:"application/octet-stream",data:data.layout[tpl],success:cb})},self.worker.postMessage({event:"Page:status",data:{text:"Importing list layout"}}),saveTemplate("list",function(){self.worker.postMessage({event:"Page:status",data:{text:"Importing detail layout"}}),saveTemplate("detail",function(){self.worker.postMessage({event:"Page:status",data:{text:"Importing edit layout"}}),saveTemplate("edit",function(){self.navigate(3)})})})},importAutoresponderTab:function(e){this.init(),$("iframe:first").unbind("load");var data=e.data,context=$(this.frameDoc);data.autoresponder&&(this.setInputs(data.autoresponder,context),$("#ctl00_cp_uc_btnSubmit",context).trigger("click")),this.worker.postMessage({event:"Page:status",data:{text:"Web app imported successfully!",css:"alert-success"}}),this.worker.postMessage({event:"WebApp:importSettings"})}}),$(document).ready(function(){var worker=null,onMessage=function(msg){if(msg.action){var info=msg.action.split(":");if(2==info.length){var className=info[0],methodName=info[1];if(window[className]){var controller=new window[className](worker);void 0!=controller[methodName]&&"function"==typeof controller[methodName]&&controller[methodName].apply(controller,msg.argv)}}}},onConnect=function(port){"BC"==port.name&&(worker=port,worker.onMessage.addListener(onMessage))};chrome.runtime.onConnect.addListener(onConnect)});